import base64
import os
import re


def load_template(template_path: str) -> str:
    """
    Load an HTML template from a file.

    Args:
        template_path (str): The file path to the HTML template.

    Returns:
        str: The content of the HTML template.
    """
    with open(template_path, "r", encoding="utf-8") as f:
        return f.read()


def _resolve_css_imports(css_content: str, css_dir: str) -> str:
    """
    Resolve CSS @import statements by reading and concatenating imported files.

    Args:
        css_content (str): The CSS content with @import statements.
        css_dir (str): The directory containing the CSS files.

    Returns:
        str: CSS content with @import statements resolved.
    """
    import_pattern = r'@import\s+url\([\'"]([^\'"]+)[\'"]\)\s*;'

    def replace_import(match):
        import_path = match.group(1)
        # Handle relative paths
        if import_path.startswith("./"):
            import_path = import_path[2:]  # Remove './'

        full_path = os.path.join(css_dir, import_path)

        if os.path.exists(full_path):
            with open(full_path, "r", encoding="utf-8") as f:
                imported_content = f.read()
            # Recursively resolve imports in the imported file
            return _resolve_css_imports(imported_content, os.path.dirname(full_path))
        else:
            # If file doesn't exist, keep the original import
            return match.group(0)

    return re.sub(import_pattern, replace_import, css_content)


def load_css(css_path: str) -> str:
    """
    Load a CSS file and return its content wrapped in a <style> tag.
    Automatically resolves @import statements by concatenating imported files.

    Args:
        css_path (str): The file path to the CSS file.

    Returns:
        str: A string with the CSS content wrapped in a <style> tag, or an empty string if the file is not found.
    """
    if os.path.exists(css_path):
        with open(css_path, "r", encoding="utf-8") as f:
            css_content = f.read()

        # Resolve @import statements
        css_dir = os.path.dirname(css_path)
        resolved_css = _resolve_css_imports(css_content, css_dir)

        return f"<style>{resolved_css}</style>"
    return ""


def embed_image(
    image_path: str, element_id: str, alt_text: str = "", mime_type: str = "image/png"
) -> str:
    """
    Embed an image into an HTML <img> tag using Base64 encoding.

    Args:
        image_path (str): The file path to the image.
        element_id (str): The HTML id attribute for the image.
        alt_text (str): Alternate text for the image.
        mime_type (str): MIME type of the image (default "image/png").

    Returns:
        str: An HTML <img> tag containing the embedded Base64 image.
             Returns an empty string if the image file does not exist.
    """
    if os.path.exists(image_path):
        with open(image_path, "rb") as img_file:
            encoded = base64.b64encode(img_file.read()).decode("utf-8")
        return f'<img id="{element_id}" src="data:{mime_type};base64,{encoded}" alt="{alt_text}">'
    return ""


def embed_favicon(favicon_path: str) -> str:
    """
    Embed a favicon into an HTML <link> tag using Base64 encoding.

    Args:
        favicon_path (str): The file path to the favicon image.

    Returns:
        str: An HTML <link> tag containing the embedded favicon.
             Returns an empty string if the favicon file does not exist.
    """
    if os.path.exists(favicon_path):
        with open(favicon_path, "rb") as icon_file:
            encoded = base64.b64encode(icon_file.read()).decode("utf-8")
        return f'<link rel="icon" href="data:image/x-icon;base64,{encoded}" type="image/x-icon">'
    return ""


def load_script(script_path: str) -> str:
    """
    Load a JavaScript file and return its content.

    Args:
        script_path (str): The file path to the JavaScript file.

    Returns:
        str: The JavaScript content as a string, or an empty string if the file is not found.
    """
    if os.path.exists(script_path):
        with open(script_path, "r", encoding="utf-8") as f:
            return f.read()
    return ""
